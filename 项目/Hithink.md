# chatbot 问答方案



## 项目背景

同花顺ifind终端（一般提供给B端的研究员用）在使用终端，希望有一个统一的对话入口，可以查询数据，表格，连接客服等。我们通过chatbot整合了



## 基于workflow的方案

流程： 用户输入 -> 问句消歧（针对多轮问句） -> 模型规划  -> 反思 -> 正文生成

1. 问句消岐

​		输入： 用户历史问句 + 历史回答  -> 完整问句。

​        细节：用户问的问题可能和前面提问相关，会省略掉主体（之前说了公司名，后面用代词），时间等信息，或者针对上一轮答案，继续追问。因此要先做一次改写，得到完整问句。

​     	数据合成：qwen-72B合成  + gpt筛选、人工校对（qwen72改写后，先让模型判断改写是否正确和判断理由，确实有歧义的让人校对）

-   历史上下文处理


​       尝试多种策略：历史问句全保留，尝试直接对所有答案进行压缩，单容易丢失信息，导致改写不准确。后续改成只保留最近3轮完整问答（改写后的），前面答案摘要成多个bullet points。

​	**问1：**为什么不考虑澄清？

​    **答1：**看到回答完全不对，用户提前终止，重新提问。如果再加一个澄清的链路，模型有容易过度澄清的倾向（一定要上下文很全才肯回答）



2. 模型规划

   i. 意图识别。

   ii. 分析框架使用。



# 类o3，基于REACT的deep reseach方案

核心两个问题:  （1）规划短思考 （2）记忆管理



## 其它

#### prompt怎么写？

有以下几个注意点：

- 格式化输出，最好用json或者xml。模型输出这个结构化数据比较容易，也好解析。如果格式出错可以用正则匹配。例如，模型生成工具列表： 1. report: xx 公司研报 2.search：xx新闻。这种多了需要解析的时候考虑把无关的去除。
- few-shot。只在关键的地方写，比如在智能query生成的时候，可以给几个例子帮助模型理解。举例子的时候最好格式多样一些！而不是统一的模板，例如模型的thought部分太简单，可以写几个good例子，告诉模型对于复杂问题，可以先仔细分析需要哪些信息，再做规划，而不是直接把问题扔到搜索工具中。再写一个badcase，告诉模型如果是简单的（查询今天天气，不要写一大串思考内容）。另外，格式之类的（1，（一））这种可以混用，没必要非要统一。另外生成答案的prompt，可以多准备几套，混合着用。
- 注意利用kv-cache。尽量把system做成固定的，可以变的部分，例如时间，用户问题放在后面。这样对不同的问题，可以复用kv-cache。

 
